---
title: "Seguimiento sub-nacional"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("")
library(rio)
library(sp)
library(geojsonio)
library(rgdal)
library(spdep)
library(pgirmess)
library(gstat)
library(maps)
library(rgeos) 
library(gtable)
library(scales)
library(ggplot2)
library(rgdal)
library(maptools)
library(Matrix)
library(LearnBayes)
library(spatstat)
library(googleVis)
library(plyr)
library(maptools)
library(leaflet)
library(htmlwidgets)
library(devtools)
```

### Gobiernos Regionales

#### Mapa de situación de casos positivos a nivel regional

```{r datos, include=FALSE}
dep <- readOGR(dsn="/cloud/project/Mapa_Covid",layer="gadm36_PER_1")
datos_regional1="https://docs.google.com/spreadsheets/d/e/2PACX-1vQkc4tZ-ZXIUtZ6CZPEarncXxE3lFMD8Tp4MahTcc-hMw2XdAbn5nSPLFwvM-6YoAv3l05t9ggK0bv-/pub?gid=1241161277&single=true&output=csv"
datos_regional1<-as.data.frame(read.csv(datos_regional1,sep = ","))

mapacondata=merge(dep,datos_regional1)#merge de la base con el mapa
```


```{r Casos Regionales, include=FALSE}
popup <- paste0("<b>", "Región: ", "</b>", as.character(mapacondata$DEPARTAMEN), "<br>",  
      "<b>", "Casos Positivos: ", "</b>", as.character(mapacondata$casos_positivos), "<br>",
      "<b>", "Total de Muestras: ", "</b>", as.character(mapacondata$muestras_regionales), "<br>",
      "<b>", "% Positivos: ", "</b>", as.character(mapacondata$casos_x_pruebas_mapa), "<br>"
      )

palfac <- colorFactor(palette=c("#fee0d2","#fc9272","#de2d26"), domain = mapacondata$casos_pruebas_mapa_categorias)

mapa <- leaflet(mapacondata) %>% addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5, opacity = 1,
              fillOpacity = 0.5, fillColor = ~palfac(mapacondata$casos_pruebas_mapa_categorias), group = "Belleza",
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE), 
              label = ~mapacondata$DEPARTAMEN, labelOptions = labelOptions(direction = "auto"), popup = popup) %>%
  addLegend(position = "topright", pal = palfac, values = ~mapacondata$casos_pruebas_mapa_categorias,
            title = "% de casos positivos por región")
```


```{r Mapa casos, eval=TRUE, echo=FALSE, fig.width=3.5}
mapa
```

#### Mapa de situación de fallecidos a nivel regional

```{r fallecidos, include=FALSE}
popup2 <- paste0("<b>", "Región: ", "</b>", as.character(mapacondata$DEPARTAMEN), "<br>",  
      "<b>", "Número de fallecidos: ", "</b>", as.character(mapacondata$fallecidos), "<br>",
      "<b>", "Mortalidad: ", "</b>", as.character(mapacondata$mortalidad), "<br>"
      )

palfac2 <- colorFactor(palette=c("#D9D9D9","#737373","darkblue","darkred"), domain = mapacondata$mortalidad_mapa_categorias)

mapa2 <- leaflet(mapacondata) %>% addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5, opacity = 1,
              fillOpacity = 0.5, fillColor = ~palfac2(mapacondata$mortalidad_mapa_categorias), group = "Belleza",
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE), 
              label = ~mapacondata$DEPARTAMEN, labelOptions = labelOptions(direction = "auto"), popup = popup2) %>%
  addLegend(position = "topright", pal = palfac2, values = ~mapacondata$mortalidad_mapa_categorias,
            title = "% de mortalidad")
```


```{r mapa fallecidos, echo=FALSE,eval=TRUE,fig.width=3.5}
mapa2
```


#### Mapa sobre la ejecución de transferencias para el COVID-19 a nivel regional

```{r presupuesto, include=FALSE}
popup3 <- paste0("<b>", "Región: ", "</b>", as.character(mapacondata$DEPARTAMEN), "<br>",  
      "<b>", "Presupuesto transferido: ", "</b>", as.character(mapacondata$transferencias_covid), "<br>",
      "<b>", "Porcentaje ejecutado: ", "</b>", as.character(mapacondata$presupuesto_covid_mapa), "<br>"
      )

palfac3 <- colorFactor(palette=c("red","orange","yellow","lightgreen","green"), domain = mapacondata$mapa_covid)

mapa3 <- leaflet(mapacondata) %>% addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5, opacity = 1,
              fillOpacity = 0.5, fillColor = ~palfac3(mapacondata$mapa_covid), group = "Belleza",
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE), 
              label = ~mapacondata$DEPARTAMEN, labelOptions = labelOptions(direction = "auto"), popup = popup3) %>%
  addLegend(position = "topright", pal = palfac3, values = ~mapacondata$mapa_covid,
            title = "% de ejecución")
```


```{r mapa presupuesto, echo=FALSE,eval=TRUE,fig.width=3.5}
mapa3
```

#### Mapa de la distribución de Equipo de Protección Personal a nivel regional

```{r EPP, include=FALSE}
popup4 <- paste0("<b>", "Región: ", "</b>", as.character(mapacondata$DEPARTAMEN), "<br>",  
      "<b>", "Unidades EPP: ", "</b>", as.character(mapacondata$distribucion_EPP), "<br>"
      )

palfac4 <- colorFactor(palette=c("#D1E5F0", "#92C5DE" ,"#2166AC", "darkblue"), domain = mapacondata$distribucion_EPP_mapa)

mapa4 <- leaflet(mapacondata) %>% addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5, opacity = 1,
              fillOpacity = 0.5, fillColor = ~palfac4(mapacondata$distribucion_EPP_mapa), group = "Belleza",
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE), 
              label = ~mapacondata$DEPARTAMEN, labelOptions = labelOptions(direction = "auto"), popup = popup4) %>%
  addLegend(position = "topright", pal = palfac4, values = ~mapacondata$distribucion_EPP_mapa,
            title = "Distribución de EPP")
```


```{r mapa EPP, echo=FALSE,eval=TRUE,fig.width=3.5}
mapa4
```


Mapas actualizados al 11 de mayo del 2020. Fuente: Base de Seguimiento Sub-nacional. Elaborado para "Politólogos en cuarentena".

#### Situación sobre movilidad de la población a nivel regional

```{r, echo=FALSE,eval=TRUE}
googlelink="https://docs.google.com/spreadsheets/d/e/2PACX-1vSmydQXYpaS6GGfV41GxItRYuKRBnYWJNZrky0yegSN95X_sLgraIpxaTabVogHMACwsXC-wABASs2C/pub?gid=0&single=true&output=csv"

googledata=as.data.frame(read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSmydQXYpaS6GGfV41GxItRYuKRBnYWJNZrky0yegSN95X_sLgraIpxaTabVogHMACwsXC-wABASs2C/pub?gid=0&single=true&output=csv"))


retail=data.frame(googledata$pais,googledata$region,googledata$date,googledata$retail)

retaildata<-retail[!is.na(retail$googledata.retail),]
retaildata2=subset(retaildata , googledata.region!="Peru")
retaildata2$googledata.date<-as.Date(retaildata2$googledata.date)


retaildata2 %>% ggplot(aes(x=googledata.date, y=googledata.retail, color=googledata.region)) +  geom_line( size=0.8) + theme_classic()  + scale_x_date(date_breaks = "1 week", date_labels = "%m-%d")+ theme(axis.text.x =element_text(angle = 70, hjust = 1)) +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-15")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-15")), y= -50, label='Inicio del Estado de emergencia'), size=2.8, angle=90, vjust=-0.4, hjust=0,color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-18")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-18")), y= -50, label='Inmovilizacion Social Obligatoria'), size=2.8, angle=90, vjust=-0.4, hjust=0,color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-31")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-31")), y= -50, label='Primera prórroga hasta el 12 de abril '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black")+geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-13")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-13")), y= -50, label='Segunda prórroga hasta el 26 de abril '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-26")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-26")), y= -50, label='Tercera prórroga hasta el 10 de mayo '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black") + labs(title = "Evolución de la mobilidad en negocios retail",caption = "Fuente: Google Mobility. Elaborado para 'Politólogos en cuarentena'" ,x = "Fecha", y="Movilidad hacia negocios retail")+ theme(legend.position = "none",plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) 

farmacia=data.frame(googledata$pais,googledata$region,googledata$date,googledata$farmacia)

farmaciadata<-farmacia[!is.na(farmacia$googledata.farmacia),]
farmaciadata2=subset(farmaciadata , googledata.region!="Peru")
farmaciadata2$googledata.date<-as.Date(farmaciadata2$googledata.date)

farmaciadata2 %>% ggplot(aes(x=googledata.date, y=googledata.farmacia, color=googledata.region)) +  geom_line( size=0.8) + theme_classic() + scale_x_date(date_breaks = "1 week", date_labels = "%m-%d")+ theme(axis.text.x =element_text(angle = 70, hjust = 1)) +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-15")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-15")), y= -50, label='Inicio del Estado de emergencia'), size=2.8, angle=90, vjust=-0.4, hjust=0,color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-18")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-18")), y= -50, label='Inmovilizacion Social Obligatoria'), size=2.8, angle=90, vjust=-0.4, hjust=0,color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-31")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-31")), y= -50, label='Primera prórroga hasta el 12 de abril '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black")+geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-13")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-13")), y= -50, label='Segunda prórroga hasta el 26 de abril '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-26")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-26")), y= -50, label='Tercera prórroga hasta el 10 de mayo '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black") + labs(title = "Evolución de la mobilidad en farmacias",caption = "Fuente: Google Mobility. Elaborado para 'Politólogos en cuarentena'" ,x = "Fecha", y="Movilidad hacia farmacias")+ theme(legend.position = "none",plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black"))


casa=data.frame(googledata$pais,googledata$region,googledata$date,googledata$residencia)

casadata<-casa[!is.na(casa$googledata.residencia),]
casadata2=subset(casadata , googledata.region!="Peru")
casadata2$googledata.date<-as.Date(casadata2$googledata.date)

casadata2 %>% ggplot(aes(x=googledata.date, y=googledata.residencia, color=googledata.region)) +  geom_line( size=0.8) + theme_classic() + scale_x_date(date_breaks = "1 week", date_labels = "%m-%d")+ theme(axis.text.x =element_text(angle = 70, hjust = 1)) +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-15")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-15")), y= 10, label='Inicio del Estado de emergencia'), size=2.8, angle=90, vjust=-0.4, hjust=0,color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-18")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-18")), y= 10, label='Inmovilizacion Social Obligatoria'), size=2.8, angle=90, vjust=-0.4, hjust=0,color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-31")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-31")), y= 10, label='Primera prórroga hasta el 12 de abril '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black")+geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-13")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-13")), y= 10, label='Segunda prórroga hasta el 26 de abril '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-26")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-26")), y= 10, label='Tercera prórroga hasta el 10 de mayo '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black") + labs(title = "Evolución de la mobilidad en zonas residenciales",caption = "Fuente: Google Mobility. Elaborado para 'Politólogos en cuarentena'" ,x = "Fecha", y="Estancia en zonas residenciales")+ theme(legend.position = "none",plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black"))
```


```{r, include=FALSE}

#### Presencia de casos positivos y nivel de gasto de los Gobiernos Regionales

#cor.test(transferencias$x_contagio,transferencias$x_presupuesto_covid)


#p<-ggplot(transferencias, aes(x_contagio,x_presupuesto_covid)) + geom_point(aes(size=casos_positivos, colour = macroregion )) + theme_classic()+ labs(x = "Positividad del COVID-19 a nivel regional (%)",y = "Ejecución de transferencias regionales (%)") 

#w<-p + labs(caption = "Fuente: Sala situacional - MINSA, Consulta Amigable MEF. Elaborado para 'Politólogos en cuarentena'")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) 

#w

#ggplotly(w, tooltip = "region") 


### Pendiente: invertir paleta de colores, colocar % a los datos
```

```{r, include=F}
### 3.2. Municipalidades provinciales


#install.packages("maptools")
#library(maptools)

#mapa provincias <- readShapeSpatial("DEPARTAMENTOS.shp")


```

```{r, include=F}
### 3.3. Municipalidades distritales

#install.packages("maptools")
#library(maptools)

#mapa distritos <- readShapeSpatial("DEPARTAMENTOS.shp")
```

```{r, include=F}

### 3.4. Lima Metropolitana y Callao

#install.packages("maptools")
#library(maptools)

#mapa sobre las acciones que han emprendido diferentes distritos en Lima

### 3.5. Labores del Comando COVID en las regiones


### 3.6. Transparencia y denuncias de corrupción a nivel subnacional


### 3.7. Retorno a las regiones


### 3.8 Buenas practicas a nivel subnacional
```





