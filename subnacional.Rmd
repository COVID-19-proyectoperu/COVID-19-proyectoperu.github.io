---
title: "Seguimiento sub-nacional"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Gobiernos Regionales

#### Datos sobre casos y muestras realizadas

```{r, echo=FALSE,eval=TRUE,warning=FALSE,message=FALSE,error=FALSE}
### cargar datos

regioneslink="https://docs.google.com/spreadsheets/d/e/2PACX-1vQkc4tZ-ZXIUtZ6CZPEarncXxE3lFMD8Tp4MahTcc-hMw2XdAbn5nSPLFwvM-6YoAv3l05t9ggK0bv-/pub?gid=1102095429&single=true&output=csv"

regiones=as.data.frame(read.csv(regioneslink))



### contruir tabla
#install.packages("dplyr")
library(dplyr)
regiones%>%
  dplyr::select("Región"="region","Muestras realizadas"="muestras_regionales", "Positivos"="casos_positivos", "Muestras x 100 mil hab."="x_100_muestras","Positivos x 100 mil hab."="x_100_positivos","Proporción de positivos"="x_contagio")%>%
  DT::datatable(
    options = list(pageLength = 10, 
                   lengthMenu = c(10, 15, 20),
                   language = list(lengthMenu = "Mostrar _MENU_ entradas",
                                   info ="Mostrando _START_ al _END_ de _TOTAL_ entradas",
                                   search = "Buscar:",
                                   paginate = list(previous = "Anterior",
                                                   'next' = "Siguiente"))
                   ),
    rownames = FALSE
  )

```

<p>
<div style="text-align:right"> Datos actualizados al 04/05/2020. Fuente: Sala Situacional-MINSA </div>
</p>


#### Transferencias a Gobiernos Regionales y su ejecución

```{r, echo=FALSE,eval=TRUE,warning=FALSE,message=FALSE,error=FALSE}
### cargar datos

regioneslink="https://docs.google.com/spreadsheets/d/e/2PACX-1vQkc4tZ-ZXIUtZ6CZPEarncXxE3lFMD8Tp4MahTcc-hMw2XdAbn5nSPLFwvM-6YoAv3l05t9ggK0bv-/pub?gid=1102095429&single=true&output=csv"

regiones=as.data.frame(read.csv(regioneslink, dec = ","))

transferencias<-regiones[!is.na(regiones$x_ejecucion_2019),]


transferencias$ejecutado=transferencias$transferencias_covid*transferencias$x_presupuesto_covid 

### contruir tabla
#install.packages("dplyr")
library(dplyr)
transferencias%>%
  dplyr::select("Región"="region","Transferencias"="transferencias_covid", "Presupuesto ejecutado"="ejecutado", "Porcentaje de presupuesto ejecutado"="x_presupuesto_covid")%>%
  DT::datatable(
    options = list(pageLength = 10, 
                   lengthMenu = c(10, 15, 20),
                   language = list(lengthMenu = "Mostrar _MENU_ entradas",
                                   info ="Mostrando _START_ al _END_ de _TOTAL_ entradas",
                                   search = "Buscar:",
                                   paginate = list(previous = "Anterior",
                                                   'next' = "Siguiente"))
                   ),
    rownames = FALSE
  )

```

<p>
<div style="text-align:right"> Datos actualizados al 03/05/2020. Fuente: Consulta amigable - MEF </div>
</p>

#### Mapa de situación de los Gobiernos Regionales

```{r,include=FALSE}
#install.packages("devtools")
library(devtools)
devtools::install_github("calderonsamuel/perumapas")

library(perumapas)
library(sf) # required 
library(ggplot2)
library(tidyverse)
library(plotly)


peru_regiones$EJECUTADO<-transferencias$x_presupuesto_covid*100

m_base=ggplot(peru_regiones) + geom_sf(aes(fill = EJECUTADO)) +theme_classic() 

m_base + scale_fill_gradient(low="lightblue", high ="darkblue") + guides(fill=guide_legend(title="Porcentaje ejecutado"))+ labs(title="Transferencias por el COVID-19 para los GR (% ejecutado)",caption = "Fuente: Consulta Amigable - MEF. Elaborado para 'Politólogos en cuarentena'")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) 
```



```{r, eval=TRUE,echo=FALSE,warning=FALSE,message=FALSE}
library(rio)
library(sp)
library(geojsonio)
library(rgdal)
library(spdep)
library(pgirmess)
library(gstat)
library(maps)
library(rgeos) 
library(gtable)
library(scales)
library(ggplot2)
library(rgdal)
library(maptools)
library(Matrix)
library(LearnBayes)
library(spatstat)
library(googleVis)
library(plyr)
library(maptools)
library(leaflet)
library(htmlwidgets)
library(devtools)

dep <- readOGR(dsn="/cloud/project/Mapa_Covid",layer="gadm36_PER_1")
datos_regional1="https://docs.google.com/spreadsheets/d/e/2PACX-1vQkc4tZ-ZXIUtZ6CZPEarncXxE3lFMD8Tp4MahTcc-hMw2XdAbn5nSPLFwvM-6YoAv3l05t9ggK0bv-/pub?gid=1241161277&single=true&output=csv"
datos_regional1<-as.data.frame(read.csv(datos_regional1))

mapacondata=merge(dep,datos_regional1)#merge de la base con el mapa

popup <- paste0("<b>", "Región: ", "</b>", as.character(mapacondata$DEPARTAMEN), "<br>",
      "<b>", "Presupesto Ejecutado: ", "</b>", as.character(mapacondata$presupuesto_covid_mapa), "<br>",
      "<b>", "Casos Positivos: ", "</b>", as.character(mapacondata$casos_positivos), "<br>",
      "<b>", "Muestras: ", "</b>", as.character(mapacondata$muestras_regionales), "<br>")

palfac <- colorFactor(palette=c("#fee0d2","#fc9272","#de2d26"), domain = mapacondata$casos_pruebas_mapa_categorias)

mapa <- leaflet(mapacondata) %>% addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5, opacity = 1,
              fillOpacity = 0.5, fillColor = ~palfac(mapacondata$casos_pruebas_mapa_categorias), group = "Belleza",
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE), 
              label = ~mapacondata$DEPARTAMEN, labelOptions = labelOptions(direction = "auto"), popup = popup) %>%
  addLegend(position = "topright", pal = palfac, values = ~mapacondata$casos_pruebas_mapa_categorias,
            title = "% de casos positivos por región") 
mapa

#<p><img src="subnacional_files/figure-html/mapa_interactivo.PNG" /><!-- --></p>

#Para conocer la situación a nivel regional: [Mapa interactivo de Gobiernos Regionales](casos_files/figure-html/mapa.html)
```


<p>
<div style="text-align:right"> Datos actualizados al 03/05/2020. Mapa elaborado por Manuel Ponte.</div>
</p>



#### Presencia de casos positivos y nivel de gasto de los Gobiernos Regionales

```{r, echo=FALSE,eval=TRUE,warning=FALSE,message=FALSE,error=FALSE}

#cor.test(transferencias$x_contagio,transferencias$x_presupuesto_covid)


p<-ggplot(transferencias, aes(x_contagio,x_presupuesto_covid)) + geom_point(aes(size=casos_positivos, colour = macroregion )) + theme_classic()+ labs(x = "Positividad del COVID-19 a nivel regional (%)",y = "Ejecución de transferencias regionales (%)") 

w<-p + labs(caption = "Fuente: Sala situacional - MINSA, Consulta Amigable MEF. Elaborado para 'Politólogos en cuarentena'")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) 

w

#ggplotly(w, tooltip = "region") 


### Pendiente: invertir paleta de colores, colocar % a los datos
```





```{r, include=F}
### 3.2. Municipalidades provinciales


#install.packages("maptools")
#library(maptools)

#mapa provincias <- readShapeSpatial("DEPARTAMENTOS.shp")


```



```{r, include=F}
### 3.3. Municipalidades distritales

#install.packages("maptools")
#library(maptools)

#mapa distritos <- readShapeSpatial("DEPARTAMENTOS.shp")
```





```{r, include=F}

### 3.4. Lima Metropolitana y Callao

#install.packages("maptools")
#library(maptools)

#mapa sobre las acciones que han emprendido diferentes distritos en Lima

### 3.5. Labores del Comando COVID en las regiones


### 3.6. Transparencia y denuncias de corrupción a nivel subnacional


### 3.7. Retorno a las regiones


### 3.8 Buenas practicas a nivel subnacional
```

```{r, include=FALSE}
googlelink="https://docs.google.com/spreadsheets/d/e/2PACX-1vSmydQXYpaS6GGfV41GxItRYuKRBnYWJNZrky0yegSN95X_sLgraIpxaTabVogHMACwsXC-wABASs2C/pub?gid=0&single=true&output=csv"

googledata=as.data.frame(read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSmydQXYpaS6GGfV41GxItRYuKRBnYWJNZrky0yegSN95X_sLgraIpxaTabVogHMACwsXC-wABASs2C/pub?gid=0&single=true&output=csv"))


view(googledata)

retail=data.frame(googledata$pais,googledata$region,googledata$date,googledata$retail)

retaildata<-retail[!is.na(retail$googledata.retail),]
retaildata2=subset(retaildata , googledata.region!="Peru")
retaildata2$googledata.date<-as.Date(retaildata2$googledata.date)

retaildata2 %>% ggplot(aes(x=googledata.date, y=googledata.retail, color=googledata.region)) +  geom_line( size=0.8) + theme_classic()    + scale_x_date(date_breaks = "1 week", date_labels = "%m-%d")+ theme(axis.text.x =element_text(angle = 70, hjust = 1)) +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-15")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-15")), y= 10, label='Inicio del Estado de emergencia'), size=2.8, angle=90, vjust=-0.4, hjust=0,color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-18")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-18")), y= 10, label='Inmovilizacion Social Obligatoria'), size=2.8, angle=90, vjust=-0.4, hjust=0,color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-31")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-31")), y= 10, label='Primera prórroga hasta el 12 de abril '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black")+geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-13")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-13")), y= 10, label='Segunda prórroga hasta el 26 de abril '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-26")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-26")), y= 10, label='Tercera prórroga hasta el 10 de mayo '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black") + labs(caption = "Fuente: Base de Seguimiento Nacional. Elaborado para 'Politólogos en cuarentena'" ,x = "Fecha", y="Número acumulado de instrumentos empleados")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) 

farmacia=data.frame(googledata$pais,googledata$region,googledata$date,googledata$farmacia)

farmaciadata<-farmacia[!is.na(farmacia$googledata.farmacia),]
farmaciadata2=subset(farmaciadata , googledata.region!="Peru")
farmaciadata2$googledata.date<-as.Date(farmaciadata2$googledata.date)

farmaciadata2 %>% ggplot(aes(x=googledata.date, y=googledata.farmacia, color=googledata.region)) +  geom_line( size=0.8) + theme_classic() 


casa=data.frame(googledata$pais,googledata$region,googledata$date,googledata$residencia)

casadata<-casa[!is.na(casa$googledata.residencia),]
casadata2=subset(casadata , googledata.region!="Peru")
casadata2$googledata.date<-as.Date(casadata2$googledata.date)

casadata2 %>% ggplot(aes(x=googledata.date, y=googledata.residencia, color=googledata.region)) +  geom_line( size=0.8) + theme_classic() + scale_x_date(date_breaks = "1 week", date_labels = "%m-%d")+ theme(axis.text.x =element_text(angle = 70, hjust = 1)) +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-15")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-15")), y= 10, label='Inicio del Estado de emergencia'), size=2.8, angle=90, vjust=-0.4, hjust=0,color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-18")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-18")), y= 10, label='Inmovilizacion Social Obligatoria'), size=2.8, angle=90, vjust=-0.4, hjust=0,color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-03-31")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-03-31")), y= 10, label='Primera prórroga hasta el 12 de abril '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black")+geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-13")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-13")), y= 10, label='Segunda prórroga hasta el 26 de abril '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black") +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-26")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-26")), y= 10, label='Tercera prórroga hasta el 10 de mayo '), size=2.8, angle=90, vjust=-0.4, hjust=0, color="black") + labs(caption = "Fuente: Base de Seguimiento Nacional. Elaborado para 'Politólogos en cuarentena'" ,x = "Fecha", y="Número acumulado de instrumentos empleados")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) 


library(foreign)
mercado=as.data.frame(read.spss("mercados.sav"))
str(mercado$P52_1)
round(prop.table(table(mercado$PROVINCIA,mercado$P52_1),1)*100,digits=2)

mercadolima=subset(mercado, CCDD=="15" & CCPP=="01")

str(mercado)

#install.packages("descr")
library(descr)
t1<-crosstab(mercadolima$DISTRITO,mercadolima$P52_1,prop.r = T,plot = F)
distritos<-levels(mercadolima$DISTRITO)
str(t1)
distritos<-t1$ColData
```

