---
title: "Evolución del COVID-19 en el Perú"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# instalar paquetes

library(tidyverse)
library(ggplot2)
library(gifski)
library(gganimate)
library(plotly)
library(dplyr)
library(ggiraph)
library(rio)
library(sp)
library(geojsonio)
library(rgdal)
library(spdep)
library(pgirmess)
library(gstat)
library(maps)
library(rgeos) 
library(gtable)
library(scales)
library(ggplot2)
library(rgdal)
library(maptools)
library(Matrix)
library(LearnBayes)
library(spatstat)
library(googleVis)
library(plyr)
library(maptools)
library(leaflet)
library(htmlwidgets)
library(devtools)
```

```{r,include=FALSE}

### Cargar la data

casosperu="https://docs.google.com/spreadsheets/d/e/2PACX-1vRJsBU46m84Yl8hUIo5c1fILeYqcSa4vDXhFyIQ_QbUJndBfLLO-N4nkHOfl5hgZMWKzv1L73oiqwzm/pub?gid=1165383620&single=true&output=csv"

casos=as.data.frame(read.csv(casosperu,header=T))

### Lectura adecuada
casos$casos_positivos<-as.numeric(casos$casos_positivos)
casos$dia<-as.Date(casos$dia)
### datos
```

###  Introducción  

<p>
<div style="text-align:justify"> El dia **06 de marzo del 2020** se registró el primer caso de coronavirus en el Perú. Fueron tomadas las medidas iniciales y el dia 15 de marzo se anuncio el inicio del Estado de Emergencia Nacional junto con la medida de Aislamiento Social Obligatorio, para esa fecha se habian registrado 71 casos positivos. Al finalizar el mes de marzo se registraron 1065 nuevos casos. Un mes después se habián pasado los 36 mil casos. </div>
</p>

<p>
En ese sentido, esta sección tiene por objetivo responder a la pregunta **¿Cómo se ha desarrollado la propagación del COVID-19 en el Perú?**  

<div style="text-align:right"> Base de los datos sobre el COVID-19 en el Perú [Aquí](https://docs.google.com/spreadsheets/d/e/2PACX-1vRJsBU46m84Yl8hUIo5c1fILeYqcSa4vDXhFyIQ_QbUJndBfLLO-N4nkHOfl5hgZMWKzv1L73oiqwzm/pub?gid=1165383620&single=true&output=csv)</div>

</p>

## Situación a nivel nacional

### Evolución de los casos positivos detectados


```{r, echo=FALSE,eval=TRUE, message=FALSE,fig.align='center'}
g1<-casos %>% ggplot(aes(x=dia, y=casos_positivos)) +  geom_area(fill="grey", alpha=0.4) +  geom_line(color="darkgreen", size=0.8) +  geom_point(size=2, color="darkgreen")+ylim(0, 100000) + theme_minimal() + labs(title="Evolución de casos positivos detectados",caption = "Fuente: Sala Situacional - Minsa. Elaborado para 'Politólogos en cuarentena'" ,x = "Fecha", y="Número de casos")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) + scale_x_date(date_breaks = "1 week", date_labels = "%m-%d") + theme(axis.text.x  =element_text(angle = 70, hjust = 1)) +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-08")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-08")), y= 10000, label='Incorporacion de las pruebas rápidas'), size=3, angle=90, vjust=-0.4, hjust=0,color="black")+ geom_text(aes(y=casos_positivos,label=casos_positivos),position=position_dodge(width = 0.9),size=2.5, vjust=1,hjust=1.2,col="black", angle=-70)


###Grafico gif
#casos %>% ggplot(aes(x=dia, y=casos_positivos)) +  geom_area(fill="grey", alpha=0.4) +  geom_line(color="darkgreen", size=0.8) +  geom_point(size=2, color="darkgreen") + theme_minimal() + labs(title="Evolución de casos positivos detectados",caption = "Fuente: Sala Situacional - Minsa. Elaborado para 'Politólogos en cuarentena'" ,x = "Fecha", y="Número de casos")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) + scale_x_date(date_breaks = "1 week", date_labels = "%m-%d") + theme(axis.text.x  =element_text(angle = 70, hjust = 1)) +geom_vline(aes(xintercept=(as.numeric(as.Date("2020-04-08")))),  linetype = 2) + geom_text(aes(x=(as.Date("2020-04-08")), y= 7000, label='Incorporacion de las pruebas rápidas'), size=3, angle=90, vjust=-0.4, hjust=0,color="black") +transition_reveal(dia)


#ggplotly(g2, tooltip = c("dia", "casos_positivos"),height = 350, width=600)

g1 
#+transition_reveal(dia)

#posit<-g1  +   geom_point_interactive(aes(y = casos_positivos,tooltip=casos_positivos), col = "darkgreen") 

#ggplotly(muertos, tooltip = c("dia", "fallecidos_total"),height = 350, width=600) 

#+transition_reveal(dia)

#girafe(code = print(posit) )

```

### Nuevos casos positivos detectados por día

```{r, echo=FALSE,eval=TRUE, message=FALSE,fig.align='center'}
g2<-casos %>% ggplot(aes(x=dia, y=c_positivos_dia)) +  geom_area(alpha=0.1) +  geom_line(color="orange", size=0.8) +  geom_point(size=2, color="orange") + theme_classic() + labs(title="Nuevos casos positivos detectados por día",caption = "Fuente: Sala Situacional - Minsa. Elaborado para 'Politólogos en cuarentena'" ,x = "Fecha", y="Número de casos")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) 

g2 + geom_text(aes(y=c_positivos_dia,label=c_positivos_dia),position=position_dodge(width = 0.9),size=2.5, vjust=-1,hjust=0.5,col="black")

#ggplotly(g2, tooltip = c("dia", "casos_positivos"),height = 350, width=600)

#+transition_reveal(dia)

```


### Evolución del total de fallecimientos

```{r, echo=FALSE,eval=TRUE, message=FALSE, warning=FALSE,fig.align='center'}

### Evolucion de fallecimientos

muertos<-casos %>% ggplot(aes(x=dia, y=fallecidos_total))+ geom_line(color="black", size=0.8) +  geom_point(size=2, color="black") + theme_minimal()+ ylim(0,3000) + labs(title= "Evolución del total de fallecimientos",x = "Fecha", y="Número de fallecidos",caption = "Fuente: Sala Situacional - Minsa. Elaborado para 'Politólogos en cuarentena'")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) 

muertos + geom_text(aes(y=fallecidos_total,label=fallecidos_total),position=position_dodge(width = 0.9),size=2.5, vjust=0.8,hjust=1.3,col="blue", angle=-70)

#m1<-muertos  +   geom_point_interactive(aes(y = fallecidos_total,tooltip=fallecidos_total), col = "black") 

#ggplotly(muertos, tooltip = c("dia", "fallecidos_total"),height = 350, width=600) 

#+transition_reveal(dia)

#girafe(code = print(m1) )

```


```{r, include=FALSE}
#### Por lugar de fallecimiento grafico
```




### Nuevos fallecimientos por día

```{r, echo=FALSE,eval=TRUE, message=FALSE,fig.align='center'}
g4<-casos %>% ggplot(aes(x=dia, y=fallecidos_dia)) +  geom_area(alpha=0.1) +  geom_line(color="#CC79A7", size=0.8) +  geom_point(size=2, color="#CC79A7") + theme_classic() + labs(title="Nuevos fallecimientos por día",caption = "Fuente: Sala Situacional - Minsa. Elaborado para 'Politólogos en cuarentena'" ,x = "Fecha", y="Número de casos")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) 

g4 + geom_text(aes(y=fallecidos_dia,label=fallecidos_dia),position=position_dodge(width = 0.9),size=2.5, vjust=-1,hjust=0.5,col="black")

#ggplotly(g2, tooltip = c("dia", "casos_positivos"),height = 350, width=600)

#+transition_reveal(dia)

```


### Evolución de nuevos de hospitalizados por dia

```{r, echo=FALSE, eval=TRUE,fig.align='center'}

hospitaldata<-casos[!is.na(casos$hospital),]


hospitalizados<-hospitaldata %>% ggplot(aes(x=dia, y=hospital))+ geom_line(color="orange", size=0.8) +  geom_point(size=2, color="orange") + theme_classic()  + labs(title= "Evolución del número de hospitalizados",x = "Fecha", y="Número de hospitalizados",caption = "Fuente: Sala Situacional - Minsa. Elaborado para 'Politólogos en cuarentena'")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) 

#p1<-hospitalizados +   geom_point_interactive(aes(y = hospital,tooltip=hospital), col = "orange") 
  
hospitalizados+geom_text(aes(y=hospital,label=hospital),position=position_dodge(width = 0.9),size=2.5, vjust=-1,hjust=0.5,col="blue")

#girafe(code = print(p1) )
```


### Evolución de nuevos de hospitalizados por dia

```{r, echo=FALSE,eval=TRUE, message=FALSE, warning=FALSE,fig.align='center'}

hospital_nuevos<-casos[!is.na(casos$hospital_nuevos),]


### Evolucion de hospitalizados

g5<-hospital_nuevos %>% ggplot(aes(x=dia, y=hospital_nuevos))+ geom_line(color="grey", size=0.8) +  geom_point(size=2, color="darkgrey") + theme_classic() + labs(title= "Evolución de nuevos de nuevos hospitalizados por dia",x = "Fecha", y="Número de hospitalizados",caption = "Fuente: Reportes diarios del Minsa. Elaborado para 'Politólogos en cuarentena'")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) 

g5 + geom_text(aes(y=hospital_nuevos,label=hospital_nuevos),position=position_dodge(width = 0.9),size=3, vjust=-1,hjust=0.5,col="blue")+ geom_hline(yintercept = 0)

#ggplotly(muertos, tooltip = c("dia", "fallecidos_total"),height = 350, width=600) 

#+transition_reveal(dia)

```

### Evolución de personas en UCI 

```{r UCI, warning=FALSE, echo=FALSE,eval=TRUE,fig.align='center'}
ucidata<-casos[!is.na(casos$uci_uso),]

uci<-ucidata %>% ggplot(aes(x=dia, y=uci_uso))+ geom_line(color="blue", size=0.8) +  geom_point(size=2, color="blue") + theme_classic() + labs(title= "Evolución de personas en UCI",x = "Fecha", y="Número de personas en UCI",caption = "Fuente: Sala Situacional - Minsa. Elaborado para 'Politólogos en cuarentena'")+ theme(plot.caption=element_text(size=8, hjust=0.5, face="italic", color="black")) + geom_text(aes(y=uci_uso,label=uci_uso),position=position_dodge(width = 0.9),size=2, vjust=-2,hjust=0.5,col="black")

uci

```


```{r pendientes, include=FALSE}
##### 1.6. Distribución de casos de COVID-19


#Entre hospitalizados, recuperados, domicilados y fallecidos en un gráfico apilado

##### 1.7. Distribución de casos de COVID-19

##### 1.8. Numero de pruebas realizadas diaria y acumulada

##### 1.9. Tasa de positivos


```


<p>
<div style="text-align:right"> Datos actualizados al 15/05/2020 </div>
</p>


## Situación a nivel sub-nacional

### Evolución regional

#### Mapa de situación de casos positivos a nivel regional

```{r datos, include=FALSE}
dep <- readOGR(dsn="/cloud/project/shape_mapas",layer="gadm36_PER_1")
datos_regional1="https://docs.google.com/spreadsheets/d/e/2PACX-1vQkc4tZ-ZXIUtZ6CZPEarncXxE3lFMD8Tp4MahTcc-hMw2XdAbn5nSPLFwvM-6YoAv3l05t9ggK0bv-/pub?gid=1241161277&single=true&output=csv"
datos_regional1<-as.data.frame(read.csv(datos_regional1,sep = ","))

mapacondata=merge(dep,datos_regional1)#merge de la base con el mapa
```


```{r Casos Regionales, include=FALSE}
popup <- paste0("<b>", "Región: ", "</b>", as.character(mapacondata$DEPARTAMEN), "<br>",  
      "<b>", "Casos Positivos: ", "</b>", as.character(mapacondata$casos_positivos), "<br>",
      "<b>", "Total de Muestras: ", "</b>", as.character(mapacondata$muestras_regionales), "<br>",
      "<b>", "% Positivos: ", "</b>", as.character(mapacondata$casos_x_pruebas_mapa), "<br>"
      )

palfac <- colorFactor(palette=c("#fee0d2","#fc9272","#de2d26"), domain = mapacondata$casos_pruebas_mapa_categorias)

mapa <- leaflet(mapacondata) %>% addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5, opacity = 1,
              fillOpacity = 0.5, fillColor = ~palfac(mapacondata$casos_pruebas_mapa_categorias), group = "Belleza",
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE), 
              label = ~mapacondata$DEPARTAMEN, labelOptions = labelOptions(direction = "auto"), popup = popup) %>%
  addLegend(position = "topright", pal = palfac, values = ~mapacondata$casos_pruebas_mapa_categorias,
            title = "% de casos positivos por región")
```


```{r Mapa casos, eval=TRUE, echo=FALSE, fig.width=3.5, fig.align='center'}
mapa
```

#### Mapa de situación de fallecidos a nivel regional

```{r fallecidos, include=FALSE}
popup2 <- paste0("<b>", "Región: ", "</b>", as.character(mapacondata$DEPARTAMEN), "<br>",
      "<b>", "Número de fallecidos: ", "</b>", as.character(mapacondata$fallecidos), "<br>",
      "<b>", "Casos Positivos: ", "</b>", as.character(mapacondata$casos_positivos), "<br>",
      "<b>", "Mortalidad: ", "</b>", as.character(mapacondata$mortalidad), "<br>"
      )

palfac2 <- colorFactor(palette=c("#D9D9D9","#737373","darkblue","darkred"), domain = mapacondata$mortalidad_mapa_categorias)

mapa2 <- leaflet(mapacondata) %>% addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5, opacity = 1,
              fillOpacity = 0.5, fillColor = ~palfac2(mapacondata$mortalidad_mapa_categorias), group = "Belleza",
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE), 
              label = ~mapacondata$DEPARTAMEN, labelOptions = labelOptions(direction = "auto"), popup = popup2) %>%
  addLegend(position = "topright", pal = palfac2, values = ~mapacondata$mortalidad_mapa_categorias,
            title = "% de mortalidad")
```


```{r mapa fallecidos, echo=FALSE,eval=TRUE,fig.width=3.5, fig.align='center'}
mapa2
```

### Evolución a nivel distrital

#### Región: Lambayeque

```{r disrtito 1, include=FALSE}
distrito <- readOGR(dsn="/cloud/project/subnacional_files",layer="DISTRITOS")
datos_distrito=import("/cloud/project/subnacional_files/Seguimiento_Sub_nacional.xlsx", sheet="DatosDistrital_Mapa")
Lambayeque <- distrito[distrito$DEPARTAMEN == "LAMBAYEQUE",]

Lambayequecondata=merge(Lambayeque,datos_distrito,by.x="IDDIST",by.y="IDDIST")
```


```{r distrito 2, include=FALSE}
popup5 <- paste0("<b>", "Departamento: ", "</b>", as.character(Lambayequecondata$DEPARTAMENTO), "<br>",
                "<b>", "Provincia: ", "</b>", as.character(Lambayequecondata$PROVINCIA.y), "<br>",
                "<b>", "Distrito: ", "</b>", as.character(Lambayequecondata$DISTRITO.y), "<br>",
                "<b>", "Casos Positivos: ", "</b>", as.character(Lambayequecondata$Casos_Positivos), "<br>")

palfac5 <- colorFactor(palette=c("#ffffcc","#a1dab4","#41b6c4","#225ea8","#636363"), domain = Lambayequecondata$Categoria)

lambayeque_mapa <- leaflet(Lambayequecondata) %>% addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5, opacity = 1,
              fillOpacity = 0.5, fillColor = ~palfac5(Lambayequecondata$Categoria), group = "Belleza",
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE), 
              label = ~Lambayequecondata$DISTRITO.y, labelOptions = labelOptions(direction = "auto"), popup = popup5) %>%
  addLegend(position = "topright", pal = palfac5, values = ~Lambayequecondata$Categoria,
            title = "% de casos positivos por distrito")
```


```{r distrito 3, eval=TRUE, echo=FALSE, fig.width=3.5, fig.align='center', message=FALSE,warning=FALSE}
lambayeque_mapa
```

#### Región: Piura

```{r Piura Data, include=FALSE}
distrito <- readOGR(dsn="/cloud/project/subnacional_files",layer="DISTRITOS")
datos_distrito=import("/cloud/project/subnacional_files/Seguimiento_Sub_nacional.xlsx", sheet="DatosDistrital_Mapa")
Piura <- distrito[distrito$DEPARTAMEN == "PIURA",]

Piuracondata=merge(Piura,datos_distrito,by.x="IDDIST",by.y="IDDIST")
```


```{r Piura Codigo, include=FALSE}
popup_Piura <- paste0("<b>", "Departamento: ", "</b>", as.character(Piuracondata$DEPARTAMENTO), "<br>",
                "<b>", "Provincia: ", "</b>", as.character(Piuracondata$PROVINCIA.y), "<br>",
                "<b>", "Distrito: ", "</b>", as.character(Piuracondata$DISTRITO.y), "<br>",
                "<b>", "Casos Positivos: ", "</b>", as.character(Piuracondata$Casos_Positivos), "<br>")

palfac_Piura <- colorFactor(palette=c("#ffffcc","#a1dab4","#41b6c4","#225ea8","#636363"), domain = Piuracondata$Categoria)

Piura_mapa <- leaflet(Piuracondata) %>% addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5, opacity = 1,
              fillOpacity = 0.5, fillColor = ~palfac_Piura(Piuracondata$Categoria), group = "Belleza",
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE), 
              label = ~Piuracondata$DISTRITO.y, labelOptions = labelOptions(direction = "auto"), popup = popup_Piura) %>%
  addLegend(position = "topright", pal = palfac_Piura, values = ~Piuracondata$Categoria,
            title = "% de casos positivos por distrito")
```


```{r Piura Mapa, eval=TRUE, echo=FALSE, fig.width=3.5, fig.align='center', message=FALSE,warning=FALSE}
Piura_mapa
```

Para ver diferentes regiones siga este [enlace](mapas_distritos.html)
